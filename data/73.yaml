#
# 73.yaml | Heroku
# https://status.heroku.com/incidents/2110
#

IR-73:

  extractedBy: JS
  reviewedBy:

  ######################################
  # Meta
  ######################################

  patterns:
    - Resources / Increase limit and monitor headroom (runway):
      - AI-1 significantly increase rate limit
      - AI-2 notify if rate limit approached (it's on people's minds)

  memos:
    - Recovery work and time: Stopping the rollout of the feature was insufficient for recovery, and just meant that "remediations began". Five hours of script writing, etc was needed; "engineers created and ran a script", "engineers created a fix for ...", 

    - Customer impact: An important part of some AIs is to avoid customer impact, rather than (say) completely prevent all issues. Notification approaches (like in this case) aim to inform engineers before the customers are affected.
  
  ######################################
  # AIs
  ######################################

  AI-1: 
    # a feature was rolled out to Private Space apps, modifying Automated Certificate Management (ACM) to create a single certificate per domain and allowing an arbitrary number of domains per app [...] This rate limit caused default domain (herokuapp.com) certificates to fail after the first 50 <subdomain>.herokuapp.com certificates were generated by ACM [...] We have worked with Letâ€™s Encrypt to increase our domain-specific rate limit by orders of magnitude.

    motivation:
      experience: Enabling (tested) feature hit limit and caused extensive failures
      lifecycle:
        - Failure / Inception
      tags:
        - deployment (feature enabled - caused rate limit to be hit leading to TLS failures)
        - limit hit (3rd party rate limit per domain)
      iso:
        - Capacity (third party rate limit)
    
    item:
      action: Increase rate limit by orders of magnitude 
      target: Networking / Third party certificate service
      goal: Avoid hitting rate limit

      action-type:
        - evo / alter
      target-type:
        - Infrastructure / Network certificate
      sts:
        - Tech / Infra
      intended-effect:
        - Performance Efficiency / Capacity
      temporal: new
      google-ai:
        - prevent

  AI-2: 
    # [Same experience as above] We will create internal alerting to make our engineers aware when the platform is at risk of approaching this rate limit to give engineers enough time to respond before there is customer impact.

    motivation:
      experience: Enabling (tested) feature hit limit and caused extensive failures
      lifecycle:
        - Response / Detection (did not avoid customer impact)
      tags:
        - deployment (feature enabled - caused rate limit to be hit leading to TLS failures)
        - limit hit (3rd party rate limit per domain)
      iso:
        - Capacity (third party rate limit)
    
    item:
      action: Add alarming for rate limit
      target: Alarming system (for rate limit)
      goal: Notify engineers before customers affected

      action-type:
        - evo / add
      target-type:
        - Monitoring and metrics
      sts:
        - Tech / Infra
      intended-effect:
        - Safety / Hazard warning
      temporal: new
      google-ai:
        - detect

  AI-3: 
    # During the incident, shortcomings were identified in our business logic around how issues with default domain (herokuapp.com) certs interact in unexpected ways with custom domains. We will investigate and remediate these issues.

    motivation:
      experience: During the incident, they had unexpected interactions between certs issued for the default domain and custom domains
      lifecycle:
        - Failure / Downstream Effects
      tags:
        - unexpected behavior (interaction between features)
      iso:
        - Fault tolerance
    
    item:
      action: Investigate and remediate these issues
      target: Certificates and domains systems (VAGUE)
      goal: Fix issues

      action-type:
        - formative / investigative
        - evo / alter
      target-type:
        - Infrastructure / Network certificate
      sts:
        - Tech / Infra
      intended-effect:
        - Reliability / Fault tolerance
      temporal: new
      google-ai:
        - investigate
        - mitigate future
    
    memos:
      - Find and fix: 'investigate and remediate these issues'